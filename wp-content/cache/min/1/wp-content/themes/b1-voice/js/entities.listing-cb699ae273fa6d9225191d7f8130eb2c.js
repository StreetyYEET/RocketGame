var EntitiesListing={initialize:function(config){this.config=config;this.url=this.prepareUrl();this.updateContentFromStorage();this.currentPage=this.currentPage||1;this.initLoadMoreButton();this.loadMoreButton.click(this.loadMorePosts.bind(this));jQuery(window).on('beforeunload',this.storeCurrentScroll.bind(this))},reinit:function(config){this.config=jQuery.extend(this.config,config);this.currentPage=1;this.updateContentFromStorage();this.initLoadMoreButton()},initLoadMoreButton:function(){this.loadMoreButton=jQuery(this.config.loadMoreButtonSelector);if(this.currentPage>=this.config.lastPage){this.loadMoreButton.hide()}else{this.loadMoreButton.show()}},loadMorePosts:function(){this.currentPage++;if(this.currentPage>this.config.lastPage){return!1}
var url=this.url.replace('{page}',this.currentPage);jQuery.ajax({url:url,success:this.processResponce.bind(this)});return!1},processResponce:function(response){var listEntities=jQuery(response).find(this.config.listingContainerSelector);if(listEntities.length){jQuery(this.loadMoreButton).html('Load More');jQuery(this.config.listingContainerSelector).append(listEntities.html())}
if(this.currentPage>=this.config.lastPage){this.loadMoreButton.hide()}
var listingData={'content':jQuery(this.config.listingContainerSelector).html(),'currentPage':this.currentPage,};window.sessionStorage.setItem(this.config.entityType+"_listing",JSON.stringify(listingData))},prepareUrl:function(){var url=window.location.href.replace(window.location.search,'');var getParams='';if(jQuery(this.config.filtersFormSelector).length){getParams+=jQuery(this.config.filtersFormSelector).serialize()}
if(window.location.search.length){url+=window.location.search;if(getParams.length){url+='&'+getParams}
url+='&pagenum={page}'}else if(getParams.length){url+='?'+getParams+'&pagenum={page}'}
return url},storeCurrentScroll:function(){window.sessionStorage.setItem(this.config.entityType+"_listing_last_scroll",jQuery(window).scrollTop())},updateContentFromStorage:function(){if(window.sessionStorage.getItem("back-button-clicked")==1){window.sessionStorage.setItem("back-button-clicked",0);var listingData=window.sessionStorage.getItem(this.config.entityType+"_listing");if(listingData&&listingData.length){listingData=jQuery.parseJSON(listingData);jQuery(this.config.listingContainerSelector).html(listingData.content);this.currentPage=listingData.currentPage}
var scrollTop=window.sessionStorage.getItem(this.config.entityType+"_listing_last_scroll");jQuery(window).scrollTop(scrollTop)}else{window.sessionStorage.setItem(this.config.entityType+"_listing","");window.sessionStorage.setItem(this.config.entityType+"_listing_last_scroll",0)}},clearStorageContent:function(type){window.sessionStorage.setItem(type+"_listing","");window.sessionStorage.setItem(type+"_listing_last_scroll",0)},}
